{% extends "base.html" %}
{% block title %}èŠå¤©{% endblock %}
{% block content %}
<div class="chat-page">
    <!-- æ·»åŠ ç§»åŠ¨ç«¯é¡¶éƒ¨æ  -->
    <div class="mobile-header">
        <button class="menu-toggle" onclick="toggleSidebar()">â‰¡</button>
        <span class="current-session-title" id="mobile-session-name">é€‰æ‹©ä¼šè¯</span>
        <button class="role-toggle" onclick="toggleMobileRoleSelector()">
            <svg class="role-icon" viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-8c.83 0 1.5-.67 1.5-1.5S7.83 9 7 9s-1.5.67-1.5 1.5S6.17 12 7 12zm8-1.5c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5.67 1.5 1.5 1.5 1.5-.67 1.5-1.5zM9 13.5c0 .83.67 1.5 1.5 1.5h3c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5h-3c-.83 0-1.5.67-1.5 1.5z"/>
            </svg>
            <div class="role-info">
                <span class="current-role-name">é»˜è®¤åŠ©æ‰‹</span>
                <span class="role-arrow">âŒ„</span>
            </div>
        </button>
    </div>

    <div class="sessions-sidebar">
        <div class="sessions-header">
            <h3>å¯¹è¯åˆ—è¡¨</h3>
            <button onclick="createSession()">æ–°å»ºå¯¹è¯</button>
        </div>
        <!-- ç§»åŠ¨ç«¯å¯¼èˆªèœå• -->
        <div class="mobile-nav">
            <a href="{{ url_for('view_announcements') }}" class="nav-item">
                <span class="icon">ğŸ“¢</span>
                <span>å…¬å‘Š</span>
            </a>
            <a href="{{ url_for('view_surveys') }}" class="nav-item">
                <span class="icon">ğŸ“‹</span>
                <span>é—®å·</span>
            </a>
        </div>
        <div id="sessions-list"></div>
    </div>
    <div class="chat-container">
        <!-- PCç«¯è§’è‰²é€‰æ‹©å™¨ -->
        <div class="role-selector desktop-only">
            <div class="role-selector-header">
                <div class="role-selector-title">
                    <span>å½“å‰è§’è‰²</span>
                    <button class="toggle-roles-btn" onclick="toggleRoleList()">
                        <span id="current-role-name">é»˜è®¤åŠ©æ‰‹</span>
                        <span class="arrow">â–¼</span>
                    </button>
                </div>
                <span id="current-role-description" class="role-description"></span>
            </div>
            <div class="role-list" style="display: none;">
                <!-- å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
            </div>
        </div>
        <div class="chat-header">
            <span id="current-session-name"></span>
            <div class="session-actions">
                <button onclick="renameSession(currentSessionId)" class="icon-button">é‡å‘½å</button>
                <button onclick="deleteSession(currentSessionId)" class="icon-button">åˆ é™¤</button>
            </div>
        </div>
        <div id="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
            <button onclick="sendMessage()">å‘é€</button>
        </div>
    </div>
</div>

<div id="announcement-modal" class="modal">
    <div class="modal-content">
        <div class="announcement-header">
            <h3>ç³»ç»Ÿå…¬å‘Š</h3>
            <span class="close">&times;</span>
        </div>
        <div id="announcement-content"></div>
        <div class="announcement-footer">
            <button onclick="markAnnouncementRead()" class="btn-primary">æˆ‘å·²é˜…è¯»</button>
        </div>
    </div>
</div>

<!-- ç§»åŠ¨ç«¯è§’è‰²é€‰æ‹©å™¨ -->
<div class="mobile-role-selector">
    <div class="mobile-role-header">
        <h3>é€‰æ‹©è§’è‰²</h3>
        <button class="close-btn" onclick="toggleMobileRoleSelector()">Ã—</button>
    </div>
    <div class="mobile-role-list">
        <!-- å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
    </div>
</div>

<script>
let currentSessionId = null;
let sessions = [];
let currentAnnouncement = null;
let pageInitialized = false;
let currentRole = null;  // æ·»åŠ å½“å‰è§’è‰²çŠ¶æ€

// è·å–CSRF token
const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

// ä¿®æ”¹åˆå§‹åŒ–å‡½æ•°
async function initializePage() {
    if (pageInitialized || initializePage.isInitializing) return;
    initializePage.isInitializing = true;
    
    try {
        setLoading(true);
        
        // æ£€æŸ¥ä¼šè¯çŠ¶æ€
        const response = await fetch('/api/check-session', {
            credentials: 'same-origin',
            headers: {
                'X-CSRF-TOKEN': csrfToken
            }
        });
        
        const data = await response.json().catch(() => ({}));
        
        if (!response.ok) {
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            } else if (response.status === 403 && data.code === 'account_disabled') {
                showMessage(data.message, 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return;
            }
            throw new Error(data.message || 'ä¼šè¯æ£€æŸ¥å¤±è´¥');
        }
        
        // è®¾ç½®åˆå§‹åŒ–æ ‡å¿—
        pageInitialized = true;
        
        // åŠ è½½ä¼šè¯åˆ—è¡¨
        const response2 = await fetch('/api/sessions', {
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken
            }
        });
        
        const sessionsData = await response2.json();
        
        if (sessionsData.status === 'success') {
            sessions = sessionsData.sessions;
            renderSessionsList();
            
            // æ¢å¤ä¸Šæ¬¡ä¼šè¯
            const savedSessionId = localStorage.getItem('currentSessionId');
            if (savedSessionId && sessions.find(s => s.session_id === parseInt(savedSessionId))) {
                await switchSession(parseInt(savedSessionId));
            } else if (sessions.length > 0) {
                await switchSession(sessions[0].session_id);
            } else {
                await createSession();
            }
            
            // æ£€æŸ¥æœªè¯»å…¬å‘Šï¼ˆéå…³é”®åŠŸèƒ½ï¼‰
            checkUnreadAnnouncements().catch(error => {
                console.error('æ£€æŸ¥æœªè¯»å…¬å‘Šå¤±è´¥:', error);
            });
        } else {
            throw new Error(sessionsData.message || 'åŠ è½½ä¼šè¯å¤±è´¥');
        }
        
    } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        showMessage('ç™»å½•çŠ¶æ€å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•', 'error');
        pageInitialized = false;
        
        // å¦‚æœæ˜¯ä¸¥é‡é”™è¯¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
        if (error.message.includes('è´¦æˆ·å·²ç¦ç”¨') || error.message.includes('ç”¨æˆ·ä¸å­˜åœ¨')) {
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        }
    } finally {
        setLoading(false);
        initializePage.isInitializing = false;
    }
}

// ä¿®æ”¹ DOMContentLoaded äº‹ä»¶å¤„ç†
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–é¡µé¢
    initializePage();
    
    // æ·»åŠ è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬
    const input = document.getElementById('message-input');
    if (input) {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    // åŠ è½½è§’è‰²åˆ—è¡¨
    loadRoles();
});

// ä¿®æ”¹ä¼šè¯æ£€æŸ¥å‡½æ•°
async function checkSession() {
    // å¦‚æœé¡µé¢å·²åˆå§‹åŒ–ï¼Œç›´æ¥è¿”å›
    if (pageInitialized) return true;
    
    // å¦‚æœæ­£åœ¨åˆå§‹åŒ–ï¼Œç­‰å¾…åˆå§‹åŒ–å®Œæˆ
    if (initializePage.isInitializing) {
        await new Promise(resolve => {
            const checkInit = () => {
                if (!initializePage.isInitializing) {
                    resolve();
                } else {
                    setTimeout(checkInit, 100);
                }
            };
            checkInit();
        });
        return pageInitialized;
    }
    
    // å¦åˆ™å¼€å§‹åˆå§‹åŒ–
    await initializePage();
    return pageInitialized;
}

// ä¿®æ”¹åŠ è½½ä¼šè¯åˆ—è¡¨å‡½æ•°
async function loadSessions() {
    try {
        const result = await fetchWithRetry('/api/sessions');
        if (result.status === 'success') {
            sessions = result.sessions;
            renderSessionsList();
            return true;
        }
        throw new Error(result.message || 'åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥');
    } catch (error) {
        console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
        showMessage('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        return false;
    }
}

// ä¿®æ”¹åˆ‡æ¢ä¼šè¯å‡½æ•°
async function switchSession(sessionId) {
    if (!sessionId || !pageInitialized) return;
    
    try {
        currentSessionId = sessionId;
        localStorage.setItem('currentSessionId', sessionId);
        
        // æ›´æ–°UI
        renderSessionsList();
        
        // æ›´æ–°ä¼šè¯åç§°
        const session = sessions.find(s => s.session_id === sessionId);
        if (session) {
            document.getElementById('current-session-name').textContent = session.session_name;
            document.getElementById('mobile-session-name').textContent = session.session_name;
        }
        
        // åŠ è½½èŠå¤©å†å²
        await loadChatHistory(sessionId);
        
        // åœ¨ç§»åŠ¨ç«¯åˆ‡æ¢ä¼šè¯åå…³é—­ä¾§è¾¹æ 
        if (window.innerWidth <= 768) {
            toggleSidebar();
        }
        
    } catch (error) {
        console.error('åˆ‡æ¢ä¼šè¯å¤±è´¥:', error);
        showMessage('åˆ‡æ¢ä¼šè¯å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible' && !pageInitialized) {
        initializePage();
    }
});

// åŠ è½½èŠå¤©å†å²
async function loadChatHistory(sessionId) {
    try {
        const result = await fetchWithRetry(`/api/history/${sessionId}`);
        if (result.status === 'success') {
            const chatContent = document.getElementById('chat-messages');
            chatContent.innerHTML = '';
            
            result.history.forEach(item => {
                appendMessage('user', item.message);
                appendMessage('assistant', item.response);
            });
            
            chatContent.scrollTop = chatContent.scrollHeight;
        } else {
            throw new Error(result.message || 'åŠ è½½å†å²è®°å½•å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
        showMessage('åŠ è½½å†å²è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// å‘é€æ¶ˆæ¯
async function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    try {
        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        appendMessage('user', message);
        messageInput.value = '';
        
        const response = await fetchWithRetry('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                message: message,
                session_id: currentSessionId
            })
        });
        
        if (response && response.status === 'success' && response.response) {
            appendMessage('assistant', response.response);
        } else {
            throw new Error(response.message || 'è·å–å›å¤å¤±è´¥');
        }
    } catch (error) {
        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        showMessage('å‘é€æ¶ˆæ¯å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        // æ˜¾ç¤ºä¸€ä¸ªå‹å¥½çš„é”™è¯¯æ¶ˆæ¯
        appendMessage('assistant', 'æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚');
    }
}

// åˆ›å»ºæ–°ä¼šè¯
async function createSession() {
    try {
        const result = await fetchWithRetry('/api/sessions', {
            method: 'POST',
            body: JSON.stringify({
                name: `å¯¹è¯ ${new Date().toLocaleString()}`
            })
        });
        
        if (result.status === 'success') {
            await loadSessions();
            switchSession(result.session_id);
        } else {
            throw new Error(result.message || 'åˆ›å»ºä¼šè¯å¤±è´¥');
        }
    } catch (error) {
        console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
        showMessage('åˆ›å»ºä¼šè¯å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// æ£€æŸ¥æœªè¯»å…¬å‘Š
async function checkUnreadAnnouncements() {
    try {
        const result = await fetchWithRetry('/api/announcements/unread');
        if (result.status === 'success' && result.announcements && result.announcements.length > 0) {
            showAnnouncements(result.announcements);
        }
    } catch (error) {
        console.error('æ£€æŸ¥æœªè¯»å…¬å‘Šå¤±è´¥:', error);
        // éå…³é”®åŠŸèƒ½ï¼Œå¤±è´¥æ—¶é™é»˜å¤„ç†
    }
}

// é‡å‘½åå½“å‰ä¼šè¯
function renameSession(sessionId) {
    const newName = prompt('è¯·è¾“å…¥æ–°çš„ä¼šè¯åç§°ï¼š');
    if (!newName) return;

    fetch(`/api/sessions/${sessionId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': csrfToken
        },
        body: JSON.stringify({ name: newName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            loadSessions();
        } else {
            alert('é‡å‘½åå¤±è´¥ï¼š' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('é‡å‘½åå¤±è´¥');
    });
}

// åˆ é™¤å½“å‰ä¼šè¯
function deleteSession(sessionId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ')) return;

    fetch(`/api/sessions/${sessionId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRF-TOKEN': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            loadSessions();
            if (currentSessionId === sessionId) {
                currentSessionId = null;
                document.getElementById('chat-messages').innerHTML = '';
            }
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼š' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('åˆ é™¤å¤±è´¥');
    });
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

function addMessage(message, isUser) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = isUser ? 'message user-message' : 'message bot-message';
    messageDiv.textContent = message;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// æ·»åŠ é”™è¯¯æç¤ºå‡½æ•°
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    document.body.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 3000);
}

// æ˜¾ç¤ºå…¬å‘Š
function showAnnouncements(announcements) {
    if (!announcements || announcements.length === 0) return;
    
    const modal = document.getElementById('announcement-modal');
    const content = document.getElementById('announcement-content');
    
    // ä¿å­˜å½“å‰å…¬å‘Š
    currentAnnouncement = announcements[0];
    
    // æ›´æ–°å…¬å‘Šå†…å®¹
    content.innerHTML = `
        <h4 class="announcement-title">${currentAnnouncement.title}</h4>
        <div class="announcement-time">å‘å¸ƒæ—¶é—´ï¼š${currentAnnouncement.created_at}</div>
        <div class="announcement-body">${currentAnnouncement.content}</div>
    `;
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    modal.style.display = 'block';
    
    // æ·»åŠ å…³é—­äº‹ä»¶
    const closeBtn = modal.querySelector('.close');
    closeBtn.onclick = function() {
        modal.style.display = 'none';
        markAnnouncementRead();
    };
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
            markAnnouncementRead();
        }
    };
}

// æ ‡è®°å…¬å‘Šå·²è¯»
async function markAnnouncementRead() {
    if (!currentAnnouncement) return;
    
    try {
        const result = await fetchWithRetry(
            `/api/announcements/${currentAnnouncement.id}/read`,
            {
                method: 'POST'
            }
        );
        
        if (result.status === 'success') {
            document.getElementById('announcement-modal').style.display = 'none';
            currentAnnouncement = null;
        } else {
            throw new Error(result.message || 'æ ‡è®°å·²è¯»å¤±è´¥');
        }
    } catch (error) {
        console.error('æ ‡è®°å…¬å‘Šå·²è¯»å¤±è´¥:', error);
        showMessage('æ ‡è®°å·²è¯»å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœªè¯»å…¬å‘Š
document.addEventListener('DOMContentLoaded', checkUnreadAnnouncements);

// æ·»åŠ æ¶ˆæ¯æç¤ºå‡½æ•°
function showMessage(message, type = 'info') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-toast ${type}`;
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    
    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
    setTimeout(() => {
        messageDiv.classList.add('show');
    }, 100);
    
    // 3ç§’åç§»é™¤
    setTimeout(() => {
        messageDiv.classList.remove('show');
        setTimeout(() => messageDiv.remove(), 3000);
    }, 3000);
}

// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
function appendMessage(role, message) {
    const chatContent = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role === 'user' ? 'user' : 'assistant'}-message`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    // æ·»åŠ è§’è‰²æ ‡è¯†
    const roleSpan = document.createElement('span');
    roleSpan.className = 'role-label';
    roleSpan.textContent = role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
    contentDiv.appendChild(roleSpan);
    
    // æ·»åŠ æ¶ˆæ¯å†…å®¹
    const textSpan = document.createElement('span');
    textSpan.className = 'message-text';
    textSpan.textContent = message;
    contentDiv.appendChild(textSpan);
    
    messageDiv.appendChild(contentDiv);
    chatContent.appendChild(messageDiv);
    chatContent.scrollTop = chatContent.scrollHeight;
}

// ä¿®æ”¹ä¼šè¯åˆ—è¡¨æ¸²æŸ“
function renderSessionsList() {
    const sessionList = document.getElementById('sessions-list');
    sessionList.innerHTML = '';
    
    sessions.forEach(session => {
        const li = document.createElement('li');
        li.className = `session-item ${session.session_id === currentSessionId ? 'active' : ''}`;
        li.dataset.sessionId = session.session_id;
        li.innerHTML = `
            <span class="session-name">${session.session_name}</span>
            <div class="session-actions">
                <button onclick="renameSession(${session.session_id})" class="btn-icon">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteSession(${session.session_id})" class="btn-icon">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        li.onclick = () => switchSession(session.session_id);
        sessionList.appendChild(li);
    });
}

// æ·»åŠ æ ·å¼
const style = document.createElement('style');
style.textContent = `
.message-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 24px;
    border-radius: 4px;
    color: white;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 1000;
}

.message-toast.show {
    opacity: 1;
    transform: translateY(0);
}

.message-toast.success {
    background-color: #10B981;
}

.message-toast.error {
    background-color: #EF4444;
}

.message-toast.info {
    background-color: #3B82F6;
}

.chat-message {
    display: flex;
    margin: 12px;
    gap: 12px;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.message-content {
    flex: 1;
    max-width: 80%;
}

.message-name {
    font-size: 14px;
    color: #6B7280;
    margin-bottom: 4px;
}

.message-text {
    padding: 12px;
    border-radius: 8px;
    background: #F3F4F6;
}

.user-message .message-text {
    background: #DBEAFE;
}

.bot-message .message-text {
    background: #F3F4F6;
}

.session-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    border-bottom: 1px solid #E5E7EB;
    cursor: pointer;
}

.session-item:hover {
    background: #F9FAFB;
}

.session-item.active {
    background: #EFF6FF;
}

.session-actions {
    display: flex;
    gap: 8px;
}

.btn-icon {
    padding: 4px;
    border: none;
    background: none;
    cursor: pointer;
    color: #6B7280;
}

.btn-icon:hover {
    color: #374151;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
}

.modal-content {
    position: relative;
    background-color: white;
    margin: 10% auto;
    padding: 20px;
    width: 80%;
    max-width: 600px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.announcement-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e5e7eb;
}

.announcement-title {
    margin: 0;
    font-size: 1.25rem;
    color: #1f2937;
}

.announcement-time {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 12px;
}

.announcement-body {
    line-height: 1.6;
    color: #374151;
}

.announcement-footer {
    margin-top: 20px;
    text-align: right;
}

.close {
    color: #6b7280;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #1f2937;
}

.btn-primary {
    background-color: #2563eb;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.btn-primary:hover {
    background-color: #1d4ed8;
}

/* æ¡Œé¢ç«¯/ç§»åŠ¨ç«¯æ˜¾ç¤ºæ§åˆ¶ */
.desktop-only {
    display: block;
}

.mobile-only {
    display: none;
}

/* ç§»åŠ¨ç«¯é¡¶éƒ¨æ  */
.mobile-header {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 50px;
    background: #fff;
    border-bottom: 1px solid #ddd;
    padding: 0 15px;
    align-items: center;
    justify-content: space-between;
    z-index: 1000;
}

/* ç§»åŠ¨ç«¯è§’è‰²åˆ‡æ¢æŒ‰é’® */
.role-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f0f2f5;
    border: none;
    border-radius: 20px;
    font-size: 14px;
    color: #333;
    cursor: pointer;
    transition: background-color 0.2s;
    min-width: 120px;
    height: 36px;
}

.role-toggle:active {
    background: #e4e6e9;
}

.role-toggle .role-icon {
    width: 24px;
    height: 24px;
    color: #666;
}

.role-toggle .role-info {
    display: flex;
    align-items: center;
    gap: 4px;
}

.role-toggle .current-role-name {
    max-width: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 500;
}

.role-toggle .role-arrow {
    font-size: 18px;
    transition: transform 0.3s;
    color: #666;
}

/* ç§»åŠ¨ç«¯è§’è‰²é€‰æ‹©å™¨æ ·å¼ */
.mobile-role-selector {
    position: fixed;
    top: 50px;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1001;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
}

.mobile-role-header {
    background: #fff;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    position: sticky;
    top: 0;
    z-index: 1;
}

.mobile-role-list {
    background: #fff;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.mobile-role-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    flex-direction: column;
    gap: 4px;
    position: relative;
    transition: background-color 0.2s;
}

.mobile-role-item:active {
    background: #f0f0f0;
}

.mobile-role-item.active {
    background: #e3f2fd;
    border-left: 4px solid #1a73e8;
}

.mobile-role-item.active:active {
    background: #d3e5fc;
}

.mobile-role-item .role-name {
    font-size: 16px;
    font-weight: 500;
    color: #333;
}

.mobile-role-item .role-description {
    font-size: 13px;
    color: #666;
    line-height: 1.4;
}

/* æ·»åŠ é€‰ä¸­æ ‡è®° */
.mobile-role-item.active::after {
    content: 'âœ“';
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #1a73e8;
    font-size: 18px;
    font-weight: bold;
}

/* ç§»åŠ¨ç«¯ä¼šè¯æ“ä½œæŒ‰é’® */
.mobile-session-actions {
    display: none;
    padding: 10px;
    background: #fff;
    border-bottom: 1px solid #ddd;
    gap: 10px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #fff;
    color: #333;
    font-size: 14px;
    cursor: pointer;
}

.action-btn:hover {
    background: #f5f5f5;
}

.action-btn .icon {
    font-size: 16px;
}

/* ç§»åŠ¨ç«¯å¯¼èˆªèœå• */
.mobile-nav {
    display: none;
    padding: 15px;
    border-bottom: 1px solid #eee;
    gap: 15px;
}

.mobile-nav .nav-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    border-radius: 8px;
    background: #f5f5f5;
    color: #333;
    text-decoration: none;
    font-size: 14px;
}

.mobile-nav .nav-item .icon {
    font-size: 18px;
}

@media screen and (max-width: 768px) {
    .mobile-nav {
        display: flex;
    }

    .chat-container {
        width: 100%;
        height: calc(100vh - 50px);
        padding-bottom: env(safe-area-inset-bottom);
        display: flex;
        flex-direction: column;
    }
    
    .chat-input {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        padding: 10px 15px;
        padding-bottom: max(10px, env(safe-area-inset-bottom));
        border-top: 1px solid #ddd;
        z-index: 100;
        display: flex;
        gap: 10px;
    }
    
    #chat-messages {
        flex: 1;
        padding-bottom: calc(70px + env(safe-area-inset-bottom));  /* ä¸ºè¾“å…¥æ¡†å’Œå®‰å…¨åŒºåŸŸç•™å‡ºç©ºé—´ */
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .sessions-sidebar {
        position: fixed;
        top: 50px;
        bottom: 0;
        left: -100%;
        width: 100%;
        height: calc(100vh - 50px);
        background: #fff;
        transition: left 0.3s ease;
        z-index: 998;
        display: flex;
        flex-direction: column;
        padding-bottom: env(safe-area-inset-bottom);
    }
    
    .sessions-list {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 20px;  /* ä¸ºåº•éƒ¨æ·»åŠ ä¸€äº›ç©ºé—´ */
    }
}

/* iOS å®‰å…¨åŒºåŸŸé€‚é… */
@supports (padding: max(0px)) {
    .mobile-header {
        padding-top: max(0px, env(safe-area-inset-top));
        height: calc(50px + env(safe-area-inset-top));
    }
    
    .chat-page {
        padding-top: calc(50px + env(safe-area-inset-top));
    }
    
    .sessions-sidebar {
        top: calc(50px + env(safe-area-inset-top));
        height: calc(100vh - 50px - env(safe-area-inset-top));
    }
    
    .chat-input {
        padding-bottom: max(15px, env(safe-area-inset-bottom));
    }
}
`;

document.head.appendChild(style);

// æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
window.addEventListener('unhandledrejection', function(event) {
    console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', event.reason);
    showMessage('å‘ç”Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
});

window.onerror = function(message, source, lineno, colno, error) {
    console.error('å…¨å±€é”™è¯¯:', {message, source, lineno, colno, error});
    showMessage('å‘ç”Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
    return false;
};

// æ·»åŠ åŠ è½½çŠ¶æ€ç®¡ç†
function setLoading(loading) {
    const loadingEl = document.getElementById('loading');
    if (!loadingEl) {
        const div = document.createElement('div');
        div.id = 'loading';
        div.className = 'loading-indicator' + (loading ? ' show' : '');
        div.innerHTML = '<div class="spinner"></div>';
        document.body.appendChild(div);
    } else {
        loadingEl.className = 'loading-indicator' + (loading ? ' show' : '');
    }
}

// æ·»åŠ ç›¸å…³æ ·å¼
const loadingStyle = `
.loading-indicator {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.loading-indicator.show {
    opacity: 1;
    pointer-events: auto;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
`;

style.textContent += loadingStyle;

// ä¿®æ”¹ fetchWithRetry å‡½æ•°
async function fetchWithRetry(url, options = {}, retries = 3) {
    const isNonCritical = url.includes('/announcements/unread');  // æ ‡è®°éå…³é”®è¯·æ±‚
    
    try {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                        ...options.headers
                    },
                    credentials: 'same-origin'
                });
                
                // å¦‚æœæœåŠ¡å™¨è¿”å›500é”™è¯¯
                if (response.status === 500) {
                    const error = new Error('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯');
                    error.isServerError = true;
                    throw error;
                }
                
                const data = await response.json().catch(() => ({
                    status: 'error',
                    message: 'è§£æå“åº”å¤±è´¥'
                }));
                
                if (!response.ok) {
                    if (response.status === 401) {
                        pageInitialized = false;
                        window.location.href = '/login';
                        return data;
                    }
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                }
                
                return data;
                
            } catch (error) {
                console.error(`Attempt ${i + 1} failed:`, error);
                // å¦‚æœæ˜¯æœåŠ¡å™¨é”™è¯¯æˆ–è¿æ¥é‡ç½®ï¼Œä¸”æ˜¯éå…³é”®è¯·æ±‚ï¼Œä¸é‡è¯•
                if ((error.isServerError || error.message.includes('ERR_CONNECTION_RESET')) && isNonCritical) {
                    throw error;
                }
                if (i === retries - 1) throw error;
                await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
            }
        }
    } finally {
        setLoading(false);
    }
}

// åˆ‡æ¢è§’è‰²åˆ—è¡¨æ˜¾ç¤º
function toggleRoleList() {
    const roleList = document.querySelector('.role-list');
    const arrow = document.querySelector('.toggle-roles-btn .arrow');
    
    if (roleList.style.display === 'none') {
        roleList.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
    } else {
        roleList.style.display = 'none';
        arrow.style.transform = '';
    }
}

// åˆ‡æ¢ç§»åŠ¨ç«¯è§’è‰²é€‰æ‹©å™¨
function toggleMobileRoleSelector() {
    const selector = document.querySelector('.mobile-role-selector');
    const roleArrow = document.querySelector('.role-toggle .role-arrow');
    selector.classList.toggle('show');
    // åˆ‡æ¢ç®­å¤´æ–¹å‘
    if (roleArrow) {
        roleArrow.style.transform = selector.classList.contains('show') ? 'rotate(180deg)' : '';
    }
}

// ä¿®æ”¹åŠ è½½è§’è‰²åˆ—è¡¨å‡½æ•°
async function loadRoles() {
    try {
        const response = await fetchWithRetry('/api/roles');
        
        if (response.status === 'success') {
            const roleList = document.querySelector('.role-list');
            const mobileRoleList = document.querySelector('.mobile-role-list');
            
            // æ¸…ç©ºç°æœ‰åˆ—è¡¨
            roleList.innerHTML = '';
            mobileRoleList.innerHTML = '';
            
            // æ›´æ–°å½“å‰è§’è‰²
            if (response.current_role) {
                document.getElementById('current-role-name').textContent = response.current_role.name;
                document.getElementById('current-role-description').textContent = response.current_role.description;
                document.querySelector('.role-toggle .current-role-name').textContent = response.current_role.name;
            }
            
            // å¡«å……è§’è‰²åˆ—è¡¨
            Object.entries(response.roles).forEach(([id, role]) => {
                // PCç«¯è§’è‰²é¡¹
                const roleItem = document.createElement('div');
                roleItem.className = 'role-item';
                roleItem.dataset.id = id;
                if (id === response.current_role?.role_id) {
                    roleItem.classList.add('active');
                }
                
                roleItem.innerHTML = `
                    <div class="role-name">${role.name}</div>
                    <div class="role-description">${role.description || ''}</div>
                `;
                
                roleItem.onclick = () => {
                    switchRole(id);
                    toggleRoleList();
                };
                
                roleList.appendChild(roleItem);
                
                // ç§»åŠ¨ç«¯è§’è‰²é¡¹
                const mobileRoleItem = document.createElement('div');
                mobileRoleItem.className = 'mobile-role-item';
                mobileRoleItem.dataset.id = id;
                if (id === response.current_role?.role_id) {
                    mobileRoleItem.classList.add('active');
                }
                
                mobileRoleItem.innerHTML = `
                    <div class="role-name">${role.name}</div>
                    <div class="role-description">${role.description || ''}</div>
                `;
                
                mobileRoleItem.onclick = () => {
                    switchRole(id);
                    toggleMobileRoleSelector();
                };
                
                mobileRoleList.appendChild(mobileRoleItem);
            });
        }
    } catch (error) {
        console.error('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥:', error);
        showMessage('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
    }
}

// åˆ‡æ¢è§’è‰²
async function switchRole(roleId) {
    try {
        console.log('å¼€å§‹åˆ‡æ¢è§’è‰²:', roleId);
        if (!roleId) {
            console.error('è§’è‰²IDä¸ºç©º');
            return;
        }
        
        const response = await fetchWithRetry(`/api/roles/${roleId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken
            }
        });
        
        console.log('åˆ‡æ¢è§’è‰²å“åº”:', response);
        
        if (response.status === 'success') {
            // æ›´æ–°å½“å‰è§’è‰²
            currentRole = response.role;
            
            // æ›´æ–°PCç«¯æ˜¾ç¤º
            const currentRoleNameEl = document.getElementById('current-role-name');
            const currentRoleDescEl = document.getElementById('current-role-description');
            if (currentRoleNameEl) currentRoleNameEl.textContent = currentRole.name;
            if (currentRoleDescEl) currentRoleDescEl.textContent = currentRole.description;
            
            // æ›´æ–°ç§»åŠ¨ç«¯æ˜¾ç¤º
            const mobileRoleNameEl = document.querySelector('.role-toggle .current-role-name');
            if (mobileRoleNameEl) mobileRoleNameEl.textContent = currentRole.name;
            
            // æ›´æ–°è§’è‰²åˆ—è¡¨é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.role-item, .mobile-role-item').forEach(item => {
                item.classList.toggle('active', item.dataset.id === roleId);
            });
            
            // å…³é—­è§’è‰²é€‰æ‹©å™¨
            if (window.innerWidth <= 768) {
                toggleMobileRoleSelector();
            } else {
                toggleRoleList();
            }
            
            showMessage(`å·²åˆ‡æ¢åˆ°${currentRole.name}`, 'success');
        } else {
            throw new Error(response.message || 'åˆ‡æ¢è§’è‰²å¤±è´¥');
        }
    } catch (error) {
        console.error('åˆ‡æ¢è§’è‰²å¤±è´¥:', error);
        showMessage('åˆ‡æ¢è§’è‰²å¤±è´¥: ' + error.message, 'error');
    }
}

// åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º
function toggleSidebar() {
    const sidebar = document.querySelector('.sessions-sidebar');
    sidebar.classList.toggle('show');
}

// åˆ‡æ¢è§’è‰²é€‰æ‹©å™¨æ˜¾ç¤º
function toggleRoleSelector() {
    const selector = document.querySelector('.role-selector');
    selector.classList.toggle('show');
}
</script>

<style>
/* èŠå¤©æ¶ˆæ¯æ ·å¼ */
.message {
    margin: 10px;
    padding: 12px;
    border-radius: 8px;
    max-width: 85%;
    clear: both;
}

.user-message {
    float: right;
    background-color: #e3f2fd;
    margin-left: 15%;
}

.assistant-message {
    float: left;
    background-color: #f5f5f5;
    margin-right: 15%;
}

.message-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.role-label {
    font-size: 0.8em;
    color: #666;
    margin-bottom: 2px;
}

.message-text {
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.5;
}

#chat-messages {
    display: flex;
    flex-direction: column;
    padding: 15px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

#chat-messages::after {
    content: '';
    display: block;
    clear: both;
}

/* ç§»åŠ¨ç«¯é¡¶éƒ¨æ  */
.mobile-header {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 50px;
    background: #fff;
    border-bottom: 1px solid #ddd;
    padding: 0 15px;
    align-items: center;
    justify-content: space-between;
    z-index: 1000;
}

.menu-toggle, .role-toggle {
    background: none;
    border: none;
    font-size: 24px;
    padding: 8px;
    cursor: pointer;
}

.current-session-title {
    flex: 1;
    text-align: center;
    font-weight: 500;
    margin: 0 10px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* è§’è‰²é€‰æ‹©å™¨æ ·å¼ */
.role-selector {
    padding: 15px;
    border-bottom: 1px solid #eee;
    background: #fff;
}

.role-selector-header {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.role-selector-title {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #666;
}

.toggle-roles-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #fff;
    cursor: pointer;
    transition: all 0.2s;
}

.toggle-roles-btn:hover {
    background: #f5f5f5;
}

.toggle-roles-btn .arrow {
    font-size: 12px;
    transition: transform 0.3s;
}

.role-list {
    margin-top: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
}

.role-item {
    padding: 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
}

.role-item:last-child {
    border-bottom: none;
}

.role-item:hover {
    background: #f5f5f5;
}

.role-item.active {
    background: #e3f2fd;
}

.role-item .role-name {
    font-weight: 500;
    margin-bottom: 4px;
}

.role-item .role-description {
    font-size: 13px;
    color: #666;
}

/* å“åº”å¼å¸ƒå±€ç›¸å…³æ ·å¼ */
@media screen and (max-width: 768px) {
    .mobile-header {
        display: flex;
    }
    
    .message {
        margin: 8px;
        padding: 10px;
        max-width: 90%;
    }
    
    .user-message {
        margin-left: 10%;
    }
    
    .assistant-message {
        margin-right: 10%;
    }

    .message-text {
        font-size: 14px;
    }

    .chat-page {
        flex-direction: column;
        height: 100vh;
        padding-top: 50px;
    }
    
    .sessions-sidebar {
        position: fixed;
        top: 50px;
        bottom: 0;
        left: -100%;
        width: 100%;
        height: calc(100% - 50px);
        background: #fff;
        transition: left 0.3s ease;
        z-index: 998;
    }
    
    .sessions-sidebar.show {
        left: 0;
    }

    .chat-container {
        width: 100%;
        height: calc(100vh - 50px);
    }

    .role-selector {
        display: none;
    }

    /* ç§»åŠ¨ç«¯è§’è‰²é€‰æ‹©å™¨æ ·å¼ */
    .mobile-role-selector {
        position: fixed;
        top: 50px;
        left: 0;
        right: 0;
        background: #fff;
        border-bottom: 1px solid #ddd;
        z-index: 999;
        transform: translateY(-100%);
        transition: transform 0.3s ease;
    }

    .mobile-role-selector.show {
        transform: translateY(0);
    }

    .mobile-session-actions {
        display: flex;
        justify-content: flex-end;
    }
}

/* ç§»åŠ¨ç«¯è§’è‰²åˆ‡æ¢æŒ‰é’® */
.role-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: #f0f2f5;
    border: none;
    border-radius: 16px;
    font-size: 14px;
    color: #333;
    cursor: pointer;
}

.role-toggle .current-role-name {
    max-width: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.role-toggle .role-icon {
    font-size: 18px;
    transition: transform 0.3s;
}

/* ç§»åŠ¨ç«¯è§’è‰²é€‰æ‹©å™¨æ ·å¼ */
.mobile-role-selector {
    position: fixed;
    top: 50px;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1001;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s;
}

.mobile-role-selector.show {
    opacity: 1;
    visibility: visible;
}

.mobile-role-header {
    background: #fff;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
}

.mobile-role-header h3 {
    margin: 0;
    font-size: 16px;
}

.close-btn {
    border: none;
    background: none;
    font-size: 24px;
    color: #666;
    padding: 0 8px;
    cursor: pointer;
}

.mobile-role-list {
    background: #fff;
    max-height: 70vh;
    overflow-y: auto;
}

.mobile-role-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.mobile-role-item.active {
    background: #e3f2fd;
}

.mobile-role-item .role-name {
    font-size: 16px;
    font-weight: 500;
}

.mobile-role-item .role-description {
    font-size: 13px;
    color: #666;
}

/* ç§»åŠ¨ç«¯ä¼šè¯æ“ä½œæŒ‰é’® */
.mobile-session-actions {
    display: none;
    padding: 10px;
    background: #fff;
    border-bottom: 1px solid #ddd;
    gap: 10px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #fff;
    color: #333;
    font-size: 14px;
    cursor: pointer;
}

.action-btn:hover {
    background: #f5f5f5;
}

.action-btn .icon {
    font-size: 16px;
}

/* ç§»åŠ¨ç«¯å¯¼èˆªèœå• */
.mobile-nav {
    display: none;
    padding: 15px;
    border-bottom: 1px solid #eee;
    gap: 15px;
}

.mobile-nav .nav-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    border-radius: 8px;
    background: #f5f5f5;
    color: #333;
    text-decoration: none;
    font-size: 14px;
}

.mobile-nav .nav-item .icon {
    font-size: 18px;
}

@media screen and (max-width: 768px) {
    .mobile-nav {
        display: flex;
    }

    .chat-container {
        width: 100%;
        height: calc(100vh - 50px);
        padding-bottom: env(safe-area-inset-bottom);
        display: flex;
        flex-direction: column;
    }
    
    .chat-input {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        padding: 10px 15px;
        padding-bottom: max(10px, env(safe-area-inset-bottom));
        border-top: 1px solid #ddd;
        z-index: 100;
        display: flex;
        gap: 10px;
    }
    
    #chat-messages {
        flex: 1;
        padding-bottom: calc(70px + env(safe-area-inset-bottom));  /* ä¸ºè¾“å…¥æ¡†å’Œå®‰å…¨åŒºåŸŸç•™å‡ºç©ºé—´ */
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .sessions-sidebar {
        position: fixed;
        top: 50px;
        bottom: 0;
        left: -100%;
        width: 100%;
        height: calc(100vh - 50px);
        background: #fff;
        transition: left 0.3s ease;
        z-index: 998;
        display: flex;
        flex-direction: column;
        padding-bottom: env(safe-area-inset-bottom);
    }
    
    .sessions-list {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 20px;  /* ä¸ºåº•éƒ¨æ·»åŠ ä¸€äº›ç©ºé—´ */
    }
}

/* iOS å®‰å…¨åŒºåŸŸé€‚é… */
@supports (padding: max(0px)) {
    .mobile-header {
        padding-top: max(0px, env(safe-area-inset-top));
        height: calc(50px + env(safe-area-inset-top));
    }
    
    .chat-page {
        padding-top: calc(50px + env(safe-area-inset-top));
    }
    
    .sessions-sidebar {
        top: calc(50px + env(safe-area-inset-top));
        height: calc(100vh - 50px - env(safe-area-inset-top));
    }
    
    .chat-input {
        padding-bottom: max(15px, env(safe-area-inset-bottom));
    }
}
</style>
{% endblock %} 